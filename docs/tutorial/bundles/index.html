<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Luvit.io Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Luvit.io Blog Atom Feed"><title data-react-helmet="true">Self-Contained Bundles | Luvit.io</title><meta data-react-helmet="true" property="og:url" content="https://unofficialluvitexperiments.github.io//docs/tutorial/bundles/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Self-Contained Bundles | Luvit.io"><meta data-react-helmet="true" name="description" content="Until now, we&#x27;ve only used the `luvit` executable. The time has finally come to learn about the other tools we&#x27;ve downloaded earlier."><meta data-react-helmet="true" property="og:description" content="Until now, we&#x27;ve only used the `luvit` executable. The time has finally come to learn about the other tools we&#x27;ve downloaded earlier."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://unofficialluvitexperiments.github.io//docs/tutorial/bundles/"><link data-react-helmet="true" rel="alternate" href="https://unofficialluvitexperiments.github.io//docs/tutorial/bundles/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://unofficialluvitexperiments.github.io//docs/tutorial/bundles/" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.d6749e14.css">
<link rel="preload" href="/assets/js/runtime~main.0c37fade.js" as="script">
<link rel="preload" href="/assets/js/main.73f1c878.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/luvit-logo-tiny-white.svg" alt="Luvit Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/luvit-logo-tiny-white.svg" alt="Luvit Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Luvit</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Home</a><a class="navbar__item navbar__link" href="/about/">About</a><a class="navbar__item navbar__link" href="/downloads/">Downloads</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/contributing/">Contributing</a><a class="navbar__item navbar__link" href="/security/">Security</a><a class="navbar__item navbar__link" href="/blog/">News</a></div><div class="navbar__items navbar__items--right"><a href="https://discord.gg/luvit" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/luvit/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/about/">About</a></li><li class="menu__list-item"><a class="menu__link" href="/downloads/">Downloads</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Documentation</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/">Table of Contents</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Tutorial</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/getting-started/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/hello-world/">Your First Luvit App</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/asynchronous-event-loop/">Enter the Event Loop</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/luvit-webserver/">A Non-Blocking Webserver</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/tutorial/bundles/">Self-Contained Bundles</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/packaging/">Packaging Made Easy</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/dependency-management/">Dependency Management and Community Packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorial/troubleshooting/">Troubleshooting and Finding Help</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Guides</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Concepts</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">References</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Contributing</a></li><li class="menu__list-item"><a class="menu__link" href="/security/">Security</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Self-Contained Bundles</h1></header><p>Until now, we&#x27;ve only used the <code>luvit</code> executable. The time has finally come to learn about the other tools we&#x27;ve downloaded earlier.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="packaging-the-echo-server"></a>Packaging the Echo Server<a class="hash-link" href="#packaging-the-echo-server" title="Direct link to heading">#</a></h2><p>One problem we haven&#x27;t yet solved: We are able to run the echo server on our system, but how do we get it to run on systems that don&#x27;t have <code>luvit</code> installed? The answer is, packaging it into a self-contained bundle, which we can then turn into a proper binary.</p><p>Unlike compiled languages such as C or C++, Lua scripts can&#x27;t simply be turned into machine code and run natively. Since they rely on a Lua interpreter to turn them into bytecode and execute that, we&#x27;ll have to cheat a little: What we <em>can</em> do is bundle a Lua interpreter with our application and have it execute the scripts, just like it would when running <code>luvit</code> on the other machine. We&#x27;ll use <code>luvi</code> for that.</p><p>There isn&#x27;t really any drawback to that approach because Lua is extremely lightweight, so you wouldn&#x27;t even know it&#x27;s there.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creating-a-luvi-bundle"></a>Creating a Luvi Bundle<a class="hash-link" href="#creating-a-luvi-bundle" title="Direct link to heading">#</a></h2><p>Before we can actually use <code>luvi</code>, we must understand a bit more about what it is and what it can (not) do. While <code>luvit</code> is the runtime we&#x27;ve used to execute the scripts on your own system, this interpretation is somewhat misleading: In reality, <code>luvi</code> is the Lua engine that runs all the scripts (and includes <code>libuv</code>, bound via <code>uv</code>). It just executes <code>luvit</code> as a special application - a so-called bundle.</p><p>A bundle in the Luvit ecosystem is simply a self-contained package following a predefined structure: It must have an entry point called <code>main.lua</code> and can be stored in either a folder or a compressed <code>.zip</code> archive (this is one reason why <code>miniz</code> is included inside <code>luvi</code>).</p><p>To see how this works, let&#x27;s quickly turn our echo HTTP server into a proper bundle by adding the entry point in the same directory:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">main.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">require(&quot;./SimpleEchoWebserver&quot;)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>You can try running this via <code>luvi .</code> inside the same folder, or by giving the relative path if running from somewhere else. Go ahead and try this if you like. It should totally work... right? But wait! There&#x27;s a problem:</p><p><img alt="05-luvi-missing-dependencies.png" src="/assets/images/05-luvi-missing-dependencies-7db46def4469bca2666237e568fc4f65.png"></p><p>What gives? It appears that the environment <code>luvi</code> provides isn&#x27;t quite the same as the one our script encountered when run via  <code>luvit</code>. We&#x27;ve already seen this back in <a href="/docs/tutorial/hello-world/#the-luvi-environment">The Luvi Environment</a>, but it&#x27;s quite easy to forget and very important, so it bears repeating!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="luvi-and-luvit-dont-get-along"></a>Luvi and Luvit Don&#x27;t Get Along<a class="hash-link" href="#luvi-and-luvit-dont-get-along" title="Direct link to heading">#</a></h2><p>There&#x27;s a reason the <code>fs</code> and <code>http</code> libraries have been referred to as &quot;Luvit APIs&quot; in these pages. They&#x27;re automatically included in <code>luvit</code>, but <code>luvi</code> only contains the most fundamental low-level libraries (like <code>jit</code>, <code>openssl</code>, <code>miniz</code> and <code>uv</code>). This means you can do <code>require(&quot;uv&quot;)</code> but <code>luvi</code> won&#x27;t find <code>http</code>, which is of course rather unfortunate considering we wanted to use it in our webserver.</p><p>One way to get around this problem is by manually downloading the <code>http</code> script and adding it to our bundle. <em>Or</em>, we could use <code>lit</code>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-luvit-packages-to-the-luvi-bundle"></a>Adding Luvit Packages to the Luvi Bundle<a class="hash-link" href="#adding-luvit-packages-to-the-luvi-bundle" title="Direct link to heading">#</a></h2><p>Lit is Luvit&#x27;s package manager, and as such it can help us install packages. And it just so happens that <code>http</code> is available as such a package. We&#x27;ll be able to include it in our bundle by typing the following in the folder that contains the bundle&#x27;s entry point, <code>main.lua</code>:</p><blockquote><p>lit install luvit/http</p></blockquote><p>After this command finished (hopefully successfully), a look inside the <code>deps</code> folder will show that it downloaded a whopping <strong>19</strong> files, including the <code>http.lua</code> package mentioned above. It&#x27;s best not to think about this too hard - HTTP is difficult, after all.</p><p>When running <code>luvi .</code> again, surely it will now work... <em>or will it</em>? (Spoiler alert: It won&#x27;t.) What are we missing, then?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="require-ception"></a>Require-ception<a class="hash-link" href="#require-ception" title="Direct link to heading">#</a></h3><p>If we recall that <a href="/docs/tutorial/hello-world/#relative-imports">Luvit comes with a special <code>require</code> handler for resolving import paths</a>, this makes a lot more sense: <code>luvi</code> doesn&#x27;t include this <code>require</code> handler as it&#x27;s yet another Luvit package, which we will now install by making Lit download it, too:</p><blockquote><p>lit install luvit/require</p></blockquote><p>After doing this, the <code>deps</code> folder includes a <code>require.lua</code> file, which containts the custom require handler we wanted to use. &quot;Hold up a second&quot;, I can hear you say, &quot;If we need this <code>require</code> package to <code>require</code> packages from the <code>deps</code> folder, then how on earth can we get the <code>require</code> itself from that folder?&quot;. The default Lua <code>require</code> definitely won&#x27;t be able to do this; it doesn&#x27;t look inside <code>deps/</code>.</p><p>The answer, in this case, is &quot;black magic&quot; (or rather, adventurous design choices): <code>luvi</code> will automatically include it into a bundle whenever it finds a <code>deps/require.lua</code> file, and this will automatically replace Lua&#x27;s standard <code>require</code>.  <em>What could possibly go wrong?</em></p><p>At long last, we&#x27;re able to execute our echo server with <code>luvi .</code>, only to see it promptly shut down without errors. What now?</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="manually-starting-the-event-loop"></a>Manually Starting the Event Loop<a class="hash-link" href="#manually-starting-the-event-loop" title="Direct link to heading">#</a></h3><p>What has happened is that our server has indeed been started; the TCP socket has been created and incoming connections would be accepted... if we hadn&#x27;t forgotten to start the <code>libuv</code> event loop. In <a href="/docs/tutorial/asynchronous-event-loop/#the-asynchronous-event-loop">The Asynchronous Event Loop</a> it was briefly mentioned that <code>luvit</code> automatically starts the event loop for us, by running <code>uv.run()</code> at the end. But <code>luvi</code> doesn&#x27;t do that (and I&#x27;ve no idea why).</p><p>Since <code>libuv</code> handles the socket connection, but only when it&#x27;s running the event loop, our script simply exited after initializing the server because <code>uv</code> wasn&#x27;t there to pick up the slack. We never got to the part where socket connections are handled asynchronously.</p><p>Doing this is thankfully very simple, assuming we don&#x27;t want to run the event loop with any specific parameters to control its behaviour (which we <em>could</em> do, if we cared to. But we don&#x27;t). All we have to do is slightly modify the bundle&#x27;s entry point to call <code>uv.run()</code>:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">main.lua</div><div class="codeBlockContent_hGly lua"><pre tabindex="0" class="prism-code language-lua codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">local uv = require(&quot;uv&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">require(&quot;./SimpleEchoWebserver&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uv.run()</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>As a side note: Doing this has absolutely no (adverse) effect when running the script via <code>luvit</code>. The loop only exits when there are no more scheduled tasks or callbacks, and in that case <code>libuv</code> simply won&#x27;t do anything when <code>luvit</code> calls <code>uv.run()</code> for the second time.</p><p>When running the bundle through <code>luvi .</code> this time around, it will <em>finally</em> work as expected. So what do we do with this now?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="creating-a-standalone-version"></a>Creating a Standalone Version<a class="hash-link" href="#creating-a-standalone-version" title="Direct link to heading">#</a></h2><p>Why, we want to create a standalone (binary) executable, of course! One that we can distribute. And we do, by simply typing this:</p><blockquote><p>luvi . --output echo-server.exe</p></blockquote><p>That&#x27;s for Windows, obviously. There&#x27;s no need to call it <code>echo-server.exe</code> on Unix-based systems, as you can imagine.
Once this is done, we are free to run <code>echo-server.exe</code> (or <code>./echo-server</code> on Unix systems) and it will start our application. Isn&#x27;t that great?</p><p>The result is that our self-contained bundle is zipped and combined with the <code>luvi</code> executable, and much like it would do when using the <code>luvit</code> bundle, it now runs our app inside its environment when started. You can actually open the executable in a zip program:</p><p><img alt="05-zip-bundle-contents.png" src="/assets/images/05-zip-bundle-contents-3d6c5922711fecee12ca7bdc7bce4a8b.png"></p><p>This particular example is using <code>7zip</code> on Windows, but it should work with any other standard <code>zip</code> utility, as well.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="scripts-and-packages-and-bundles-oh-my"></a>Scripts and Packages and Bundles, Oh My<a class="hash-link" href="#scripts-and-packages-and-bundles-oh-my" title="Direct link to heading">#</a></h2><p>Since we&#x27;ve just created a self-containing executable, we could already deploy our application to other machines and run it as-is.</p><p>There are two remaining issues, though:</p><ol><li>The zip archive contains every single file and folder from our directory, even those not actually needed by the <code>main.lua</code> script</li><li>Packaging apps as binary and distributing them is very inconvenient, particularly when multiple versions will inevitably exist</li></ol><p>The first is due to <code>luvi</code> not really caring to figure out <em>what</em> should be bundled with our application, but rather handling the bundling process itself. And the second requires the use of a proper package managing tool, which is exactly what <code>lit</code> was made for.</p><p>In the next (and final) part of this tutorial, we&#x27;ll be creating a Lit package that we can distribute and run anywhere we want.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/luvit/luvit.io/edit/master/website/docs/03-documentation/02-tutorial/05-creating-luvi-bundles.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tutorial/luvit-webserver/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« A Non-Blocking Webserver</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tutorial/packaging/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Packaging Made Easy »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#packaging-the-echo-server" class="table-of-contents__link">Packaging the Echo Server</a></li><li><a href="#creating-a-luvi-bundle" class="table-of-contents__link">Creating a Luvi Bundle</a></li><li><a href="#luvi-and-luvit-dont-get-along" class="table-of-contents__link">Luvi and Luvit Don&#39;t Get Along</a></li><li><a href="#adding-luvit-packages-to-the-luvi-bundle" class="table-of-contents__link">Adding Luvit Packages to the Luvi Bundle</a><ul><li><a href="#require-ception" class="table-of-contents__link">Require-ception</a></li><li><a href="#manually-starting-the-event-loop" class="table-of-contents__link">Manually Starting the Event Loop</a></li></ul></li><li><a href="#creating-a-standalone-version" class="table-of-contents__link">Creating a Standalone Version</a></li><li><a href="#scripts-and-packages-and-bundles-oh-my" class="table-of-contents__link">Scripts and Packages and Bundles, Oh My</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ©2015-2021 The Luvit Authors</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0c37fade.js"></script>
<script src="/assets/js/main.73f1c878.js"></script>
</body>
</html>