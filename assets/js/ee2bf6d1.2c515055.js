"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[7867],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},l=Object.keys(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(i=0;i<l.length;i++)n=l[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var u=i.createContext({}),s=function(e){var t=i.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=s(e.components);return i.createElement(u.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,l=e.originalType,u=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=s(n),h=a,m=c["".concat(u,".").concat(h)]||c[h]||d[h]||l;return n?i.createElement(m,r(r({ref:t},p),{},{components:n})):i.createElement(m,r({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=n.length,r=new Array(l);r[0]=c;var o={};for(var u in t)hasOwnProperty.call(t,u)&&(o[u]=t[u]);o.originalType=e,o.mdxType="string"==typeof e?e:a,r[1]=o;for(var s=2;s<l;s++)r[s]=n[s];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8051:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return u},metadata:function(){return s},toc:function(){return p},default:function(){return c}});var i=n(7462),a=n(3366),l=(n(7294),n(3905)),r=["components"],o={sidebar_position:6,slug:"/docs/tutorial/bundles"},u="Self-Contained Bundles",s={unversionedId:"documentation/tutorial/creating-luvi-bundles",id:"documentation/tutorial/creating-luvi-bundles",isDocsHomePage:!1,title:"Self-Contained Bundles",description:"Until now, we've only used the `luvit` executable. The time has finally come to learn about the other tools we've downloaded earlier.",source:"@site/docs/03-documentation/02-tutorial/05-creating-luvi-bundles.md",sourceDirName:"03-documentation/02-tutorial",slug:"/docs/tutorial/bundles",permalink:"/docs/tutorial/bundles",editUrl:"https://github.com/luvit/luvit.io/edit/master/website/docs/03-documentation/02-tutorial/05-creating-luvi-bundles.md",version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6,slug:"/docs/tutorial/bundles"},sidebar:"tutorialSidebar",previous:{title:"A Non-Blocking Webserver",permalink:"/docs/tutorial/luvit-webserver"},next:{title:"Packaging Made Easy",permalink:"/docs/tutorial/packaging"}},p=[{value:"Packaging the Echo Server",id:"packaging-the-echo-server",children:[]},{value:"Creating a Luvi Bundle",id:"creating-a-luvi-bundle",children:[]},{value:"Luvi and Luvit Don&#39;t Get Along",id:"luvi-and-luvit-dont-get-along",children:[]},{value:"Adding Luvit Packages to the Luvi Bundle",id:"adding-luvit-packages-to-the-luvi-bundle",children:[{value:"Require-ception",id:"require-ception",children:[]},{value:"Manually Starting the Event Loop",id:"manually-starting-the-event-loop",children:[]}]},{value:"Creating a Standalone Version",id:"creating-a-standalone-version",children:[]},{value:"Scripts and Packages and Bundles, Oh My",id:"scripts-and-packages-and-bundles-oh-my",children:[]}],d={toc:p};function c(e){var t=e.components,o=(0,a.Z)(e,r);return(0,l.kt)("wrapper",(0,i.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"self-contained-bundles"},"Self-Contained Bundles"),(0,l.kt)("p",null,"Until now, we've only used the ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," executable. The time has finally come to learn about the other tools we've downloaded earlier."),(0,l.kt)("h2",{id:"packaging-the-echo-server"},"Packaging the Echo Server"),(0,l.kt)("p",null,"One problem we haven't yet solved: We are able to run the echo server on our system, but how do we get it to run on systems that don't have ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," installed? The answer is, packaging it into a self-contained bundle, which we can then turn into a proper binary."),(0,l.kt)("p",null,"Unlike compiled languages such as C or C++, Lua scripts can't simply be turned into machine code and run natively. Since they rely on a Lua interpreter to turn them into bytecode and execute that, we'll have to cheat a little: What we ",(0,l.kt)("em",{parentName:"p"},"can")," do is bundle a Lua interpreter with our application and have it execute the scripts, just like it would when running ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," on the other machine. We'll use ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," for that."),(0,l.kt)("p",null,"There isn't really any drawback to that approach because Lua is extremely lightweight, so you wouldn't even know it's there."),(0,l.kt)("h2",{id:"creating-a-luvi-bundle"},"Creating a Luvi Bundle"),(0,l.kt)("p",null,"Before we can actually use ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi"),", we must understand a bit more about what it is and what it can (not) do. While ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," is the runtime we've used to execute the scripts on your own system, this interpretation is somewhat misleading: In reality, ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," is the Lua engine that runs all the scripts (and includes ",(0,l.kt)("inlineCode",{parentName:"p"},"libuv"),", bound via ",(0,l.kt)("inlineCode",{parentName:"p"},"uv"),"). It just executes ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," as a special application - a so-called bundle."),(0,l.kt)("p",null,"A bundle in the Luvit ecosystem is simply a self-contained package following a predefined structure: It must have an entry point called ",(0,l.kt)("inlineCode",{parentName:"p"},"main.lua")," and can be stored in either a folder or a compressed ",(0,l.kt)("inlineCode",{parentName:"p"},".zip")," archive (this is one reason why ",(0,l.kt)("inlineCode",{parentName:"p"},"miniz")," is included inside ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi"),")."),(0,l.kt)("p",null,"To see how this works, let's quickly turn our echo HTTP server into a proper bundle by adding the entry point in the same directory:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-lua",metastring:'title="main.lua"',title:'"main.lua"'},'require("./SimpleEchoWebserver")\n')),(0,l.kt)("p",null,"You can try running this via ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi .")," inside the same folder, or by giving the relative path if running from somewhere else. Go ahead and try this if you like. It should totally work... right? But wait! There's a problem:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"05-luvi-missing-dependencies.png",src:n(2775).Z})),(0,l.kt)("p",null,"What gives? It appears that the environment ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," provides isn't quite the same as the one our script encountered when run via  ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit"),". We've already seen this back in ",(0,l.kt)("a",{parentName:"p",href:"/docs/tutorial/hello-world#the-luvi-environment"},"The Luvi Environment"),", but it's quite easy to forget and very important, so it bears repeating!"),(0,l.kt)("h2",{id:"luvi-and-luvit-dont-get-along"},"Luvi and Luvit Don't Get Along"),(0,l.kt)("p",null,"There's a reason the ",(0,l.kt)("inlineCode",{parentName:"p"},"fs")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"http"),' libraries have been referred to as "Luvit APIs" in these pages. They\'re automatically included in ',(0,l.kt)("inlineCode",{parentName:"p"},"luvit"),", but ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," only contains the most fundamental low-level libraries (like ",(0,l.kt)("inlineCode",{parentName:"p"},"jit"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"openssl"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"miniz")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"uv"),"). This means you can do ",(0,l.kt)("inlineCode",{parentName:"p"},'require("uv")')," but ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," won't find ",(0,l.kt)("inlineCode",{parentName:"p"},"http"),", which is of course rather unfortunate considering we wanted to use it in our webserver."),(0,l.kt)("p",null,"One way to get around this problem is by manually downloading the ",(0,l.kt)("inlineCode",{parentName:"p"},"http")," script and adding it to our bundle. ",(0,l.kt)("em",{parentName:"p"},"Or"),", we could use ",(0,l.kt)("inlineCode",{parentName:"p"},"lit"),"."),(0,l.kt)("h2",{id:"adding-luvit-packages-to-the-luvi-bundle"},"Adding Luvit Packages to the Luvi Bundle"),(0,l.kt)("p",null,"Lit is Luvit's package manager, and as such it can help us install packages. And it just so happens that ",(0,l.kt)("inlineCode",{parentName:"p"},"http")," is available as such a package. We'll be able to include it in our bundle by typing the following in the folder that contains the bundle's entry point, ",(0,l.kt)("inlineCode",{parentName:"p"},"main.lua"),":"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"lit install luvit/http")),(0,l.kt)("p",null,"After this command finished (hopefully successfully), a look inside the ",(0,l.kt)("inlineCode",{parentName:"p"},"deps")," folder will show that it downloaded a whopping ",(0,l.kt)("strong",{parentName:"p"},"19")," files, including the ",(0,l.kt)("inlineCode",{parentName:"p"},"http.lua")," package mentioned above. It's best not to think about this too hard - HTTP is difficult, after all."),(0,l.kt)("p",null,"When running ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi .")," again, surely it will now work... ",(0,l.kt)("em",{parentName:"p"},"or will it"),"? (Spoiler alert: It won't.) What are we missing, then?"),(0,l.kt)("h3",{id:"require-ception"},"Require-ception"),(0,l.kt)("p",null,"If we recall that ",(0,l.kt)("a",{parentName:"p",href:"/docs/tutorial/hello-world#relative-imports"},"Luvit comes with a special ",(0,l.kt)("inlineCode",{parentName:"a"},"require")," handler for resolving import paths"),", this makes a lot more sense: ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," doesn't include this ",(0,l.kt)("inlineCode",{parentName:"p"},"require")," handler as it's yet another Luvit package, which we will now install by making Lit download it, too:"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"lit install luvit/require")),(0,l.kt)("p",null,"After doing this, the ",(0,l.kt)("inlineCode",{parentName:"p"},"deps")," folder includes a ",(0,l.kt)("inlineCode",{parentName:"p"},"require.lua"),' file, which containts the custom require handler we wanted to use. "Hold up a second", I can hear you say, "If we need this ',(0,l.kt)("inlineCode",{parentName:"p"},"require")," package to ",(0,l.kt)("inlineCode",{parentName:"p"},"require")," packages from the ",(0,l.kt)("inlineCode",{parentName:"p"},"deps")," folder, then how on earth can we get the ",(0,l.kt)("inlineCode",{parentName:"p"},"require"),' itself from that folder?". The default Lua ',(0,l.kt)("inlineCode",{parentName:"p"},"require")," definitely won't be able to do this; it doesn't look inside ",(0,l.kt)("inlineCode",{parentName:"p"},"deps/"),"."),(0,l.kt)("p",null,'The answer, in this case, is "black magic" (or rather, adventurous design choices): ',(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," will automatically include it into a bundle whenever it finds a ",(0,l.kt)("inlineCode",{parentName:"p"},"deps/require.lua")," file, and this will automatically replace Lua's standard ",(0,l.kt)("inlineCode",{parentName:"p"},"require"),".  ",(0,l.kt)("em",{parentName:"p"},"What could possibly go wrong?")),(0,l.kt)("p",null,"At long last, we're able to execute our echo server with ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi ."),", only to see it promptly shut down without errors. What now?"),(0,l.kt)("h3",{id:"manually-starting-the-event-loop"},"Manually Starting the Event Loop"),(0,l.kt)("p",null,"What has happened is that our server has indeed been started; the TCP socket has been created and incoming connections would be accepted... if we hadn't forgotten to start the ",(0,l.kt)("inlineCode",{parentName:"p"},"libuv")," event loop. In ",(0,l.kt)("a",{parentName:"p",href:"/docs/tutorial/asynchronous-event-loop#the-asynchronous-event-loop"},"The Asynchronous Event Loop")," it was briefly mentioned that ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," automatically starts the event loop for us, by running ",(0,l.kt)("inlineCode",{parentName:"p"},"uv.run()")," at the end. But ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," doesn't do that (and I've no idea why)."),(0,l.kt)("p",null,"Since ",(0,l.kt)("inlineCode",{parentName:"p"},"libuv")," handles the socket connection, but only when it's running the event loop, our script simply exited after initializing the server because ",(0,l.kt)("inlineCode",{parentName:"p"},"uv")," wasn't there to pick up the slack. We never got to the part where socket connections are handled asynchronously."),(0,l.kt)("p",null,"Doing this is thankfully very simple, assuming we don't want to run the event loop with any specific parameters to control its behaviour (which we ",(0,l.kt)("em",{parentName:"p"},"could")," do, if we cared to. But we don't). All we have to do is slightly modify the bundle's entry point to call ",(0,l.kt)("inlineCode",{parentName:"p"},"uv.run()"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-lua",metastring:'title="main.lua"',title:'"main.lua"'},'local uv = require("uv")\n\nrequire("./SimpleEchoWebserver")\n\nuv.run()\n')),(0,l.kt)("p",null,"As a side note: Doing this has absolutely no (adverse) effect when running the script via ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit"),". The loop only exits when there are no more scheduled tasks or callbacks, and in that case ",(0,l.kt)("inlineCode",{parentName:"p"},"libuv")," simply won't do anything when ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," calls ",(0,l.kt)("inlineCode",{parentName:"p"},"uv.run()")," for the second time."),(0,l.kt)("p",null,"When running the bundle through ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi .")," this time around, it will ",(0,l.kt)("em",{parentName:"p"},"finally")," work as expected. So what do we do with this now?"),(0,l.kt)("h2",{id:"creating-a-standalone-version"},"Creating a Standalone Version"),(0,l.kt)("p",null,"Why, we want to create a standalone (binary) executable, of course! One that we can distribute. And we do, by simply typing this:"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"luvi . --output echo-server.exe")),(0,l.kt)("p",null,"That's for Windows, obviously. There's no need to call it ",(0,l.kt)("inlineCode",{parentName:"p"},"echo-server.exe")," on Unix-based systems, as you can imagine.\nOnce this is done, we are free to run ",(0,l.kt)("inlineCode",{parentName:"p"},"echo-server.exe")," (or ",(0,l.kt)("inlineCode",{parentName:"p"},"./echo-server")," on Unix systems) and it will start our application. Isn't that great?"),(0,l.kt)("p",null,"The result is that our self-contained bundle is zipped and combined with the ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," executable, and much like it would do when using the ",(0,l.kt)("inlineCode",{parentName:"p"},"luvit")," bundle, it now runs our app inside its environment when started. You can actually open the executable in a zip program:"),(0,l.kt)("p",null,(0,l.kt)("img",{alt:"05-zip-bundle-contents.png",src:n(8889).Z})),(0,l.kt)("p",null,"This particular example is using ",(0,l.kt)("inlineCode",{parentName:"p"},"7zip")," on Windows, but it should work with any other standard ",(0,l.kt)("inlineCode",{parentName:"p"},"zip")," utility, as well."),(0,l.kt)("h2",{id:"scripts-and-packages-and-bundles-oh-my"},"Scripts and Packages and Bundles, Oh My"),(0,l.kt)("p",null,"Since we've just created a self-containing executable, we could already deploy our application to other machines and run it as-is."),(0,l.kt)("p",null,"There are two remaining issues, though:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"The zip archive contains every single file and folder from our directory, even those not actually needed by the ",(0,l.kt)("inlineCode",{parentName:"li"},"main.lua")," script"),(0,l.kt)("li",{parentName:"ol"},"Packaging apps as binary and distributing them is very inconvenient, particularly when multiple versions will inevitably exist")),(0,l.kt)("p",null,"The first is due to ",(0,l.kt)("inlineCode",{parentName:"p"},"luvi")," not really caring to figure out ",(0,l.kt)("em",{parentName:"p"},"what")," should be bundled with our application, but rather handling the bundling process itself. And the second requires the use of a proper package managing tool, which is exactly what ",(0,l.kt)("inlineCode",{parentName:"p"},"lit")," was made for."),(0,l.kt)("p",null,"In the next (and final) part of this tutorial, we'll be creating a Lit package that we can distribute and run anywhere we want."))}c.isMDXComponent=!0},2775:function(e,t,n){t.Z=n.p+"assets/images/05-luvi-missing-dependencies-7db46def4469bca2666237e568fc4f65.png"},8889:function(e,t,n){t.Z=n.p+"assets/images/05-zip-bundle-contents-3d6c5922711fecee12ca7bdc7bce4a8b.png"}}]);